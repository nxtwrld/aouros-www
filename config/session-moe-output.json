{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mediqom.com/schemas/session-moe-visualization.json",
  "title": "Medical Session MoE Visualization Schema",
  "description": "Schema for visualizing medical session analysis with Mixture of Experts",
  "type": "object",
  "required": ["sessionId", "timestamp", "analysisVersion", "nodes"],
  "properties": {
    "sessionId": {
      "type": "string",
      "description": "Unique identifier for the session",
      "pattern": "^session_[0-9]{8}_[0-9]{6}$"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of analysis"
    },
    "analysisVersion": {
      "type": "integer",
      "minimum": 1,
      "description": "Version number of this analysis iteration"
    },
    "nodes": {
      "$ref": "#/definitions/nodes"
    },
    "userActions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/userAction"
      },
      "description": "User interactions with the visualization"
    }
  },
  "definitions": {
    "relationship": {
      "type": "object",
      "required": ["nodeId", "relationship", "direction", "strength"],
      "properties": {
        "nodeId": {
          "type": "string",
          "pattern": "^(sym|diag|treat|q|safety)_[a-zA-Z0-9_]+$",
          "description": "ID of the related node"
        },
        "relationship": {
          "type": "string",
          "enum": [
            "supports",
            "contradicts", 
            "confirms",
            "rules_out",
            "suggests",
            "treats",
            "manages",
            "prevents",
            "relieves",
            "investigates",
            "clarifies",
            "explores",
            "excludes",
            "reveals",
            "indicates",
            "requires"
          ],
          "description": "Type of relationship between nodes"
        },
        "direction": {
          "type": "string",
          "enum": ["incoming", "outgoing", "bidirectional"],
          "description": "Direction of relationship from this node's perspective"
        },
        "strength": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Strength/confidence of this relationship"
        },
        "reasoning": {
          "type": "string",
          "description": "Explanation for this relationship"
        }
      },
      "additionalProperties": false
    },
    "nodes": {
      "type": "object",
      "required": ["symptoms"],
      "properties": {
        "symptoms": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/symptomNode"
          },
          "description": "All patient symptoms including current, historical, and suspected"
        },
        "diagnoses": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/diagnosisNode"
          },
          "description": "Potential diagnoses with probabilities"
        },
        "treatments": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/treatmentNode"
          },
          "description": "Recommended treatments linked to diagnoses"
        },
        "actions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/actionNode"
          },
          "description": "Questions and safety alerts requiring attention or response"
        }
      },
      "additionalProperties": false
    },
    "symptomNode": {
      "type": "object",
      "required": ["id", "text", "severity", "confidence", "source"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^sym_[a-zA-Z0-9_]+$",
          "description": "Unique symptom identifier"
        },
        "text": {
          "type": "string",
          "minLength": 1,
          "description": "Symptom description"
        },
        "severity": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Severity scale: 1 (critical) to 10 (minimal)"
        },
        "duration": {
          "type": "number",
          "description": "Duration of symptom in days"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence in symptom identification"
        },
        "source": {
          "type": "string",
          "enum": ["transcript", "medical_history", "family_history", "social_history", "medication_history", "suspected"],
          "description": "Source of symptom identification: transcript (current consultation), various history types, or suspected"
        },
        "quote": {
          "type": "string",
          "description": "Text we are basing the symptom on: part of the transcript, reference to medical history, source or suspicion"
        },
        "fromQuestion": {
          "type": "string",
          "pattern": "^q_[a-zA-Z0-9_]+$",
          "description": "Question ID that revealed this symptom. References existing question if it was derived as a result."
        },
        "characteristics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Additional symptom characteristics"
        },
        "suggestedBy": {
          "type": "string",
          "pattern": "^diag_[a-zA-Z0-9_]+$",
          "description": "Diagnosis ID that suggested this suspected symptom"
        },
        "relevance": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Relevance score to current case (for context-derived symptoms)"
        },
        "documentId": {
          "type": "string",
          "description": "Reference to source document (for context-derived symptoms)"
        },
        "relationships": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/relationship"
          },
          "description": "All relationships this symptom has with other nodes"
        }
      },
      "additionalProperties": false
    },
    "diagnosisNode": {
      "type": "object",
      "required": ["id", "name", "probability", "priority"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^diag_[a-zA-Z0-9_]+$",
          "description": "Unique diagnosis identifier"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Diagnosis name"
        },
        "probability": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Probability of this diagnosis"
        },
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Priority scale: 1 (critical) to 10 (low)"
        },
        "icd10": {
          "type": "string",
          "pattern": "^[A-Z][0-9]{2}(\\.[0-9]{1,3})?$",
          "description": "ICD-10 diagnosis code"
        },
        "reasoning": {
          "type": "string",
          "description": "Clinical reasoning for this diagnosis"
        },
        "relationships": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/relationship"
          },
          "description": "All relationships this diagnosis has with other nodes (symptoms, treatments, etc.)"
        },
        "redFlags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Critical warning signs"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence in diagnosis"
        },
        "suppressed": {
          "type": "boolean",
          "description": "Whether diagnosis has been ruled out"
        },
        "suppressionReason": {
          "type": "string",
          "description": "Reason for ruling out diagnosis"
        },
        "requiresInvestigation": {
          "type": "boolean",
          "description": "Whether further investigation is needed"
        },
        "subtype": {
          "type": "string",
          "description": "Diagnosis subtype or variant"
        }
      },
      "additionalProperties": false
    },
    "actionNode": {
      "type": "object",
      "required": ["id", "text", "category", "actionType", "priority", "status"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^(q|safety)_[a-zA-Z0-9_]+$",
          "description": "Unique action identifier"
        },
        "text": {
          "type": "string",
          "minLength": 1,
          "description": "Question text or safety alert message"
        },
        "category": {
          "type": "string",
          "enum": [
            "symptom_exploration",
            "diagnostic_clarification",
            "treatment_selection",
            "risk_assessment",
            "drug_interaction",
            "contraindication",
            "allergy",
            "warning",
            "red_flag"
          ],
          "description": "Category of action - questions for diagnostic chain, alerts for safety"
        },
        "actionType": {
          "type": "string",
          "enum": ["question", "alert"],
          "description": "Whether this requires user input (question) or awareness (alert)"
        },
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Priority scale: 1 (critical) to 10 (low)"
        },
        "status": {
          "type": "string",
          "enum": ["pending", "answered", "acknowledged", "skipped", "resolved"],
          "description": "Current status of the action"
        },
        "relationships": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/relationship"
          },
          "description": "All relationships this action has with other nodes (symptoms, diagnoses, treatments)"
        },
        "impact": {
          "type": "object",
          "properties": {
            "symptoms": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^sym_[a-zA-Z0-9_]+$"
              },
              "description": "New suspected symptoms this might reveal"
            },
            "diagnoses": {
              "type": "object",
              "additionalProperties": {
                "type": "number",
                "minimum": -1,
                "maximum": 1
              },
              "description": "Impact on diagnosis probabilities"
            },
            "yes": {
              "type": "object",
              "additionalProperties": {
                "type": "number"
              },
              "description": "Impact if answered yes (for questions)"
            },
            "no": {
              "type": "object",
              "additionalProperties": {
                "type": "number"
              },
              "description": "Impact if answered no (for questions)"
            }
          },
          "description": "Expected impact if action is addressed"
        },
        "answer": {
          "type": "string",
          "description": "For questions: the answer provided"
        },
        "recommendation": {
          "type": "string",
          "description": "For alerts: recommended action to take"
        },
        "type": {
          "type": "string",
          "enum": ["confirmatory", "exclusionary", "exploratory"],
          "description": "Question type (legacy field for backward compatibility)"
        },
        "connectionType": {
          "type": "string",
          "enum": ["symptom_to_diagnosis", "diagnosis_to_treatment"],
          "description": "How this question connects in diagnostic chain (legacy field)"
        }
      },
      "additionalProperties": false
    },
    "treatmentNode": {
      "type": "object",
      "required": ["id", "type", "name", "priority"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^treat_[a-zA-Z0-9_]+$",
          "description": "Unique treatment identifier"
        },
        "type": {
          "type": "string",
          "enum": ["medication", "procedure", "therapy", "lifestyle", "investigation", "immediate"],
          "description": "Type of treatment"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Treatment name"
        },
        "dosage": {
          "type": "string",
          "description": "Medication dosage"
        },
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Priority scale: 1 (critical) to 10 (low)"
        },
        "relationships": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/relationship"
          },
          "description": "All relationships this treatment has with other nodes (diagnoses, symptoms, etc.)"
        },
        "contraindications": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Known contraindications"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence in treatment recommendation"
        },
        "effectiveness": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Expected effectiveness"
        },
        "historicalEffectiveness": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Past effectiveness for this patient"
        },
        "description": {
          "type": "string",
          "description": "Detailed treatment description"
        },
        "urgency": {
          "type": "string",
          "enum": ["immediate", "urgent", "routine"],
          "description": "Treatment urgency"
        },
        "reasoning": {
          "type": "string",
          "description": "Clinical reasoning for this treatment"
        },
        "duration": {
          "type": "string",
          "description": "Treatment duration"
        },
        "requiresFollowUp": {
          "type": "boolean",
          "description": "Whether follow-up is required"
        },
        "mechanism": {
          "type": "string",
          "description": "Mechanism of action"
        },
        "sideEffects": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Potential side effects"
        }
      },
      "additionalProperties": false
    },
    "userAction": {
      "type": "object",
      "required": ["timestamp", "action", "targetId"],
      "properties": {
        "timestamp": {
          "type": "string",
          "description": "When the action occurred"
        },
        "action": {
          "type": "string",
          "enum": ["suppress", "accept", "modify", "add_note", "highlight", "question"],
          "description": "Type of user action"
        },
        "targetId": {
          "type": "string",
          "pattern": "^(sym|diag|treat|q|safety)_[a-zA-Z0-9_]+$",
          "description": "Target node ID"
        },
        "reason": {
          "type": "string",
          "description": "Reason for the action"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "User's confidence in the action"
        },
        "note": {
          "type": "string",
          "description": "Additional notes"
        }
      },
      "additionalProperties": false
    }
  }
}